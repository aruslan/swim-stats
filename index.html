<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Swim Stats</title>
  <meta name="viewport" content="width=400, initial-scale=1">
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }
    .container {
      display: flex;
      flex-direction: row;
      margin: 30px 0;
      background: #111;
      border-radius: 20px;
      box-shadow: 0 4px 20px #000a;
      overflow: hidden;
      min-width: 380px;
    }
    .left {
      padding: 24px 0 24px 24px;
    }
    .table {
      border-collapse: collapse;
      min-width: 240px;
    }
    .table th, .table td {
      font-size: 15px;
      padding: 2px 8px;
      text-align: right;
    }
    .table th { color: #aaa; font-weight: 600;}
    .official { color: #fff; font-weight: bold;}
    .unofficial { color: #aaa; font-weight: bold;}
    .delta-good { color: #39c570; }
    .delta-bad { color: #ff3333; }
    .delta-empty { color: #fff;}
    .right {
      background: #000;
      padding: 24px 24px 24px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 80px;
      border-left: 2px solid #222;
    }
    .name-btn {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 1px;
      margin-bottom: 24px;
      margin-top: 6px;
      text-align: center;
      background: none;
      border: none;
      color: #fff;
      width: 60px;
      padding: 8px 0;
      cursor: pointer;
      border-radius: 8px;
      transition: background .1s;
    }
    .name-btn:hover, .name-btn:focus {
      background: #232;
      outline: none;
    }
    .stroke-btn {
      display: block;
      width: 60px;
      margin: 3px 0;
      padding: 5px 0;
      border: none;
      border-radius: 9px;
      background: none;
      color: #aaa;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background .12s, color .12s;
      text-align: center;
    }
    .stroke-btn.active {
      background: #39c570;
      color: #fff;
    }
    .stroke-btn:focus { outline: none; }
  </style>
</head>
<body>
<div class="container">
  <div class="left">
    <table class="table" id="statsTable">
      <thead>
        <tr>
          <th>Event</th>
          <th>Time</th>
          <th>Δ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="right" id="strokesCol">
    <!-- Buttons and name will be injected here -->
  </div>
</div>
<script>
const SWIMMERS = {
  "AA": {name:"Anna Abdikeeva"},
  "VD": {name:"Valerie Dronova"},
  "IR": {name:"Imari Racine"}
};
const SWIMMER_KEYS = Object.keys(SWIMMERS);
let swimmerIndex = 0; // Start at Anna
let swimmerKey = SWIMMER_KEYS[swimmerIndex];
let swimmerName = SWIMMERS[swimmerKey].name;

const STROKES = ["BR", "FR", "FL", "BK", "IM"];
const STROKE_LABELS = {
  "FR":"Freestyle",
  "BK":"Backstroke",
  "BR":"Breaststroke",
  "FL":"Butterfly",
  "IM":"IM"
};
const STROKE_BTN_LABELS = {
  "FR":"Free", "BK":"Back", "BR":"Breast", "FL":"Fly", "IM":"IM"
};
const EVENTS = [50, 100, 200, 400];
const FORMATS = ["LCM", "SCY"];

const TIMES_URL = "./times.json";
const UNOFFICIAL_URL = "./unofficial_times.json";
const B_URL = "./b_times_11_12.json";

// Data stores
let bTimes = {}, allOfficialTimes = [], allUnofficialTimes = [];
let officialTimes = [], unofficialTimes = [];

function parseTime(s) {
  if (!s) return Infinity;
  if (s.includes(':')) {
    let [m,sec] = s.split(':');
    return parseInt(m)*60 + parseFloat(sec);
  }
  return parseFloat(s);
}
function fmt(s) { return s || "—"; }

async function fetchAllData() {
  const [times, unofficial, b] = await Promise.all([
    fetch(TIMES_URL).then(r=>r.json()),
    fetch(UNOFFICIAL_URL).then(r=>r.json()),
    fetch(B_URL).then(r=>r.json())
  ]);
  bTimes = b;
  allOfficialTimes = times;
  allUnofficialTimes = unofficial;
  setSwimmer(swimmerIndex); // initial
}

function setSwimmer(index) {
  swimmerIndex = index;
  swimmerKey = SWIMMER_KEYS[swimmerIndex];
  swimmerName = SWIMMERS[swimmerKey].name;
  officialTimes = allOfficialTimes.filter(r => r.name === swimmerName).map(r=>({...r, unofficial:false}));
  unofficialTimes = allUnofficialTimes.filter(r => r.name === swimmerName).map(r=>({...r, unofficial:true}));
}

function renderTable(strokeCode) {
  const strokeFull = STROKE_LABELS[strokeCode];
  let rows = '';
  for (let fmtType of FORMATS) {
    for (let ev of EVENTS) {
      const b = bTimes[strokeFull]?.[fmtType]?.[String(ev)];
      if (b == null) continue;
      const eventKey = `${ev} ${strokeCode} ${fmtType}`;
      // Merge, sort by time
      const times = officialTimes.concat(unofficialTimes).filter(r=>r.event === eventKey);
      if (!times.length) {
        rows += `<tr>
          <td>${ev} ${fmtType}</td>
          <td>—</td>
          <td></td>
        </tr>`;
        continue;
      }
      const candidate = times.sort((a,b)=>parseTime(a.time)-parseTime(b.time))[0];
      const timeClass = candidate.unofficial ? 'unofficial' : 'official';
      let delta = '', deltaClass = 'delta-empty';
      if (b != null) {
        const diff = parseTime(candidate.time) - b;
        if (candidate.time && candidate.time !== "—") {
          if (diff <= 0) {
            delta = "B " + diff.toFixed(2);
            deltaClass = "delta-good";
          } else {
            delta = "+" + diff.toFixed(2);
            deltaClass = "delta-bad";
          }
        }
      }
      rows += `<tr>
        <td>${ev} ${fmtType}</td>
        <td class="${timeClass}">${fmt(candidate.time)}</td>
        <td class="${deltaClass}">${delta}</td>
      </tr>`;
    }
  }
  document.querySelector('#statsTable tbody').innerHTML = rows;
}

function renderStrokes(currentStroke) {
  const col = document.getElementById('strokesCol');
  col.innerHTML = '';
  // Name as a button
  const nameBtn = document.createElement('button');
  nameBtn.className = 'name-btn';
  nameBtn.innerText = SWIMMERS[swimmerKey].name.split(' ')[0];
  nameBtn.onclick = () => {
    // Next swimmer, cycle back to zero
    const nextIndex = (swimmerIndex + 1) % SWIMMER_KEYS.length;
    setSwimmer(nextIndex);
    renderTable(currentStroke);
    renderStrokes(currentStroke);
  };
  col.appendChild(nameBtn);

  // Stroke buttons
  STROKES.forEach(sc => {
    const btn = document.createElement('button');
    btn.className = 'stroke-btn' + (sc === currentStroke ? ' active' : '');
    btn.innerText = STROKE_BTN_LABELS[sc];
    btn.onclick = () => {
      renderTable(sc);
      renderStrokes(sc);
    };
    col.appendChild(btn);
  });
}

async function main() {
  await fetchAllData();
  let currentStroke = STROKES[0];
  renderTable(currentStroke);
  renderStrokes(currentStroke);
}

main();
</script>
</body>
</html>
