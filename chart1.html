<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Swim Time Progression</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #fff;
      color: #222;
      margin: 0;
      padding: 0 0 48px 0;
    }
    .container {
      max-width: 800px;
      margin: 30px auto;
      background: #f7f7f7;
      border-radius: 14px;
      box-shadow: 0 4px 20px #0001;
      padding: 24px 24px 16px 24px;
    }
    h1, h2 { color: #2d3d50; }
    label, select {
      font-size: 1.1em;
      margin-bottom: 1.2em;
      display: inline-block;
    }
    .chart-section {
      margin-bottom: 42px;
    }
    canvas {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px #0002;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
<div class="container">
  <h1>Swim Time Progression</h1>
  <label for="swimmer-select"><strong>Select swimmer:</strong></label>
  <select id="swimmer-select"></select>
  <div id="charts"></div>
</div>
<script>
// ---------- CONFIG ----------
const TIMES_URL = "./times.json";
const B_URL = "./b_times_11_12.json";
const BB_URL = "./bb_times_11_12.json";

// Parse "MM/DD/YYYY" to ISO date for Chart.js
function toISODate(dateStr) {
  if (!dateStr) return null;
  if (typeof dateStr !== "string") return null;
  if (dateStr.includes('-')) return dateStr;
  const [m, d, y] = dateStr.split('/');
  return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
}
// Parse time string to seconds
function parseTime(str) {
  if (str == null) return null;
  str = String(str);
  if (str.includes(':')) {
    const [m, sec] = str.split(':');
    return parseInt(m, 10) * 60 + parseFloat(sec);
  }
  return parseFloat(str);
}

// Map "50 FR LCM" to {distance, stroke, format}
function parseEventKey(event) {
  // e.g., "50 FR LCM"
  const parts = event.split(" ");
  if (parts.length === 3) {
    return { distance: parts[0], stroke: parts[1], format: parts[2] };
  }
  return { distance: "", stroke: "", format: "" };
}

// Load all required data and render
async function loadAndRender() {
  const [times, bTimes, bbTimes] = await Promise.all([
    fetch(TIMES_URL).then(r => r.json()),
    fetch(B_URL).then(r => r.json()),
    fetch(BB_URL).then(r => r.json())
  ]);

  // Unique swimmers, sort alphabetically
  const swimmers = Array.from(new Set(times.map(r => r.name))).sort();

  // -- SWIMMER SELECTION --
  const select = document.getElementById('swimmer-select');
  select.innerHTML = swimmers.map(name =>
    `<option value="${name}">${name}</option>`
  ).join('');

  // Default: Anna, or first swimmer
  const urlSwimmer = new URLSearchParams(location.search).get('swimmer');
  let swimmerName = urlSwimmer || swimmers.find(n => n.includes("Anna")) || swimmers[0];
  select.value = swimmerName;

  select.onchange = () => {
    renderCharts(select.value, times, bTimes, bbTimes);
  };

  // Initial render
  renderCharts(swimmerName, times, bTimes, bbTimes);
}

// Find all event types for a swimmer
function getEventTypesForSwimmer(times, swimmerName) {
  return Array.from(
    new Set(
      times.filter(r => r.name === swimmerName)
        .map(r => r.event)
    )
  );
}

// Render all charts for one swimmer
function renderCharts(swimmerName, times, bTimes, bbTimes) {
  const chartsDiv = document.getElementById('charts');
  chartsDiv.innerHTML = ""; // Clear previous

  const events = getEventTypesForSwimmer(times, swimmerName);

  // For each event, create a chart
  events.forEach(eventKey => {
    const { distance, stroke, format } = parseEventKey(eventKey);
    // Data for this swimmer and event, sorted by date
    const records = times.filter(r =>
      r.name === swimmerName && r.event === eventKey && r.date
    ).sort((a, b) => new Date(toISODate(a.date)) - new Date(toISODate(b.date)));

    if (records.length === 0) return; // nothing to show

    // B/BB lines (if available)
    // Get B/BB for this event type
    const strokeMap = {
      "FR": "Freestyle",
      "BK": "Backstroke",
      "BR": "Breaststroke",
      "FL": "Butterfly",
      "IM": "IM"
    };
    const sLabel = strokeMap[stroke] || stroke;
    const bVal = bTimes?.[sLabel]?.[format]?.[distance] || null;
    const bbVal = bbTimes?.[sLabel]?.[format]?.[distance] || null;

    // Prepare datasets
    const dataPoints = records.map(r => ({
      x: toISODate(r.date),
      y: parseTime(r.time),
      label: `${r.meet} (${r.time})`
    }));

    // Build chart container and canvas
    const section = document.createElement("div");
    section.className = "chart-section";
    section.innerHTML = `
      <h2>${distance} ${stroke} (${format})</h2>
      <canvas></canvas>
    `;
    chartsDiv.appendChild(section);
    const ctx = section.querySelector('canvas').getContext('2d');

    // Compose chart datasets
    const datasets = [
      {
        label: "Swim time",
        data: dataPoints,
        borderColor: "#2196f3",
        backgroundColor: "#2196f344",
        pointBackgroundColor: "#2196f3",
        pointRadius: 5,
        tension: 0.15
      }
    ];

    // Add B/BB lines if present
    if (bVal) {
      datasets.push({
        label: "B Standard",
        data: dataPoints.map(dp => ({x: dp.x, y: parseTime(bVal)})),
        borderColor: "#2ecc40",
        backgroundColor: "#2ecc4044",
        borderDash: [6, 6],
        pointRadius: 0,
        fill: false,
        tension: 0
      });
    }
    if (bbVal) {
      datasets.push({
        label: "BB Standard",
        data: dataPoints.map(dp => ({x: dp.x, y: parseTime(bbVal)})),
        borderColor: "#e67e22",
        backgroundColor: "#e67e2244",
        borderDash: [2, 8],
        pointRadius: 0,
        fill: false,
        tension: 0
      });
    }

    // Chart.js config
    new Chart(ctx, {
      type: 'line',
      data: { datasets },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
            labels: { color: "#222", font: { size: 13, weight: 'bold' } }
          },
          title: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                if (context.dataset.label === "Swim time") {
                  const {label} = context.raw;
                  return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} sec (${label})`;
                }
                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' sec';
              }
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'month',
              tooltipFormat: 'MMM dd, yyyy'
            },
            title: { display: true, text: 'Date', color: '#222' },
            ticks: { color: '#222' }
          },
          y: {
            title: { display: true, text: 'Time (seconds)', color: '#222' },
            ticks: { color: '#222' }
          }
        }
      }
    });
  });
}

loadAndRender();
</script>
</body>
</html>